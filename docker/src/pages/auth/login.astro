---
const pocketbaseUrl = process.env.POCKETBASE_URL;
const redirectUrl = Astro.url.searchParams.get("rd") || "/";
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Login</title>
		<style>
			* { box-sizing: border-box; margin: 0; padding: 0; }
			body { font-family: system-ui, sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #f5f5f5; }
			.container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; width: 100%; }
			h1 { margin-bottom: 1rem; }
			p { color: #666; margin-bottom: 1.5rem; }
			.buttons { display: flex; flex-direction: column; gap: 0.75rem; }
			button { padding: 0.75rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; transition: opacity 0.2s; }
			button:hover { opacity: 0.9; }
			.github { background: #24292e; color: white; }
			.google { background: #4285f4; color: white; }
			.microsoft { background: #00a4ef; color: white; }
		</style>
	</head>
	<body>
		<div class="container">
			<h1>Login</h1>
			<p>Please sign in to continue.</p>
			<div class="buttons">
				<button class="github" id="loginGithub">Continue with GitHub</button>
				<button class="google" id="loginGoogle">Continue with Google</button>
				<button class="microsoft" id="loginMicrosoft">Continue with Microsoft</button>
			</div>
		</div>

		<script is:inline define:vars={{ pocketbaseUrl, redirectUrl }}>
			import PocketBase from "https://cdn.jsdelivr.net/npm/pocketbase@0.26.0/dist/pocketbase.es.mjs";

			const pb = new PocketBase(pocketbaseUrl);

			async function login(provider) {
				try {
					await pb.collection("users").authWithOAuth2({ provider });
					await fetch("/auth/cookie", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({ token: pb.authStore.token }),
					});
					window.location.href = redirectUrl;
				} catch (err) {
					console.error("Login failed:", err);
					alert("Login failed. Please try again.");
				}
			}

			document.getElementById("loginGithub").onclick = () => login("github");
			document.getElementById("loginGoogle").onclick = () => login("google");
			document.getElementById("loginMicrosoft").onclick = () => login("microsoft");
		</script>
	</body>
</html>
